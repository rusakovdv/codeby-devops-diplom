name: Terraform Plan & Apply (Yandex Cloud)

on:
  pull_request:
    branches: [ "main" ]
    paths:
      - "infrastructure/terraform/**"
      - ".github/workflows/infra-deploy.yml"


permissions:
  contents: read
  pull-requests: write

env:
  WORKDIR: infrastructure/terraform

jobs:
  plan:
    name: Terraform Plan
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false
    

      - name: Configure Terraform provider mirror
        run: |
            cat > $RUNNER_TEMP/terraformrc <<'EOF'
            provider_installation {
            network_mirror {
                url = "https://terraform-mirror.yandexcloud.net/"
                include = ["registry.terraform.io/*/*"]
            }
            direct {
                exclude = ["registry.terraform.io/*/*"]
            }
            }
            EOF

            echo "TF_CLI_CONFIG_FILE=$RUNNER_TEMP/terraformrc" >> $GITHUB_ENV

      - name: Debug secrets presence
        env:
            YC_SA_KEY_JSON: ${{ secrets.YC_SA_KEY_JSON }}
            YC_CLOUD_ID: ${{ secrets.YC_CLOUD_ID }}
            YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
            ACCESS_KEY: ${{ secrets.YC_S3_ACCESS_KEY_ID }}
            SECRET_KEY: ${{ secrets.YC_S3_SECRET_ACCESS_KEY }}
        run: |
            set -e

            check_var () {
            VAR_NAME="$1"
            VAR_VALUE="${!VAR_NAME}"

            if [ -z "$VAR_VALUE" ]; then
                echo "âŒ $VAR_NAME is EMPTY or NOT SET"
                exit 1
            else
                echo "âœ… $VAR_NAME is set"
            fi
            }

            echo "ðŸ” Checking required secrets..."

            check_var YC_SA_KEY_JSON
            check_var YC_CLOUD_ID
            check_var YC_FOLDER_ID
            check_var ACCESS_KEY
            check_var SECRET_KEY

            echo "ðŸŽ‰ All required secrets are present"


      - name: Configure Yandex Cloud credentials
        env:
          YC_SA_KEY_JSON: ${{ secrets.YC_SA_KEY_JSON }}
        run: |
          mkdir -p "$RUNNER_TEMP/yc"
          echo "$YC_SA_KEY_JSON" > "$RUNNER_TEMP/yc/sa-key.json"

          echo "YC_SERVICE_ACCOUNT_KEY_FILE=$RUNNER_TEMP/yc/sa-key.json" >> $GITHUB_ENV
          echo "YC_CLOUD_ID=${{ secrets.YC_CLOUD_ID }}" >> $GITHUB_ENV
          echo "YC_FOLDER_ID=${{ secrets.YC_FOLDER_ID }}" >> $GITHUB_ENV

      - name: Terraform Init
        working-directory: infrastructure/terraform
        env:
            ACCESS_KEY: ${{ secrets.YC_S3_ACCESS_KEY_ID }}
            SECRET_KEY: ${{ secrets.YC_S3_SECRET_ACCESS_KEY }}
        run: |
            terraform init -input=false -backend-config="access_key=${ACCESS_KEY}" -backend-config="secret_key=${SECRET_KEY}"


      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -input=false -out=tfplan -no-color
        continue-on-error: false

      - name: Create Plan String
        id: plan_string
        run: |
          terraform show -no-color tfplan > plan.txt
          {
            echo 'PLAN_CONTENT<<EOF'
            cat plan.txt | grep -v 'Refreshing state' | tail -c 60000 # ÐžÐ±Ñ€ÐµÐ·Ð°ÐµÐ¼, ÐµÑÐ»Ð¸ ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ð´Ð»Ð¸Ð½Ð½Ñ‹Ð¹
            echo 'EOF'
          } >> $GITHUB_ENV
          SUMMARY=$(grep -Eo 'Plan: [0-9]+ to add, [0-9]+ to change, [0-9]+ to destroy\.' plan.txt | tail -n 1 || echo "No changes")
          echo "SUMMARY=$SUMMARY" >> $GITHUB_ENV

      - name: Comment PR with plan
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## Terraform Plan

            **Summary:** `${{ env.SUMMARY }}`  
            
            <details><summary>Show full plan</summary>

            ```hcl
            ${{ env.PLAN_CONTENT }}
            ```
            </details>

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: ${{ env.WORKDIR }}/tfplan
          retention-days: 1

  apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: plan
    environment: deploy

    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Configure Yandex Cloud credentials
        env:
          YC_SA_KEY_JSON: ${{ secrets.YC_SA_KEY_JSON }}
        run: |
          mkdir -p "$RUNNER_TEMP/yc"
          echo "$YC_SA_KEY_JSON" > "$RUNNER_TEMP/yc/sa-key.json"

          echo "YC_SERVICE_ACCOUNT_KEY_FILE=$RUNNER_TEMP/yc/sa-key.json" >> $GITHUB_ENV
          echo "YC_CLOUD_ID=${{ secrets.YC_CLOUD_ID }}" >> $GITHUB_ENV
          echo "YC_FOLDER_ID=${{ secrets.YC_FOLDER_ID }}" >> $GITHUB_ENV

      - name: Configure Object Storage backend
        run: |
          echo "AWS_ACCESS_KEY_ID=${{ secrets.YC_S3_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.YC_S3_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=ru-central1" >> $GITHUB_ENV
          echo "AWS_EC2_METADATA_DISABLED=true" >> $GITHUB_ENV

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: ${{ env.WORKDIR }}

      - name: Terraform Init
        run: terraform init -input=false

      - name: Terraform Apply
        run: terraform apply -input=false -auto-approve tfplan
